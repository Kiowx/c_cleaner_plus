name: Build and Release Windows EXE

# è§¦å‘æ¡ä»¶ï¼š
on:
  # 1. å½“ä½ æ¨é€ v å¼€å¤´çš„ tag æ—¶è‡ªåŠ¨è§¦å‘ (ä¾‹å¦‚ v0.2.3 æˆ– v0.2.4-alpha)
  push:
    tags:
      - 'v*'
  # 2. å…è®¸åœ¨ GitHub ç½‘é¡µä¸Šçº¯æ‰‹åŠ¨ç‚¹å‡»è§¦å‘
  workflow_dispatch: 
    inputs:
      version_tag:
        description: 'è¯·è¾“å…¥ä½ è¦å‘å¸ƒçš„ç‰ˆæœ¬å· (ä¾‹å¦‚: v0.2.4 æˆ– v0.2.4-alpha)'
        required: true
        default: 'v0.2.4-alpha'

# èµ‹äºˆ GitHub Action åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶çš„æƒé™
permissions:
  contents: write

jobs:
  build:
    name: Package Windows Executable
    runs-on: windows-latest  # ä½¿ç”¨å¾®è½¯æä¾›çš„ Windows Server äº‘ç¯å¢ƒ

    steps:
    - name: 1. æ£€å‡ºä»£ç  (Checkout code)
      uses: actions/checkout@v4
      with:
        # è®¾ä¸º 0 ä»¥æ‹‰å–æ‰€æœ‰å†å²è®°å½•ï¼Œç¡®ä¿èƒ½å¤Ÿå›æº¯å’Œå¯¹æ¯”å†å² Commit
        fetch-depth: 0 

    - name: 2. è®¾ç½® Python ç¯å¢ƒ (Set up Python)
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' 

    - name: 3. å®‰è£…ä¾èµ–åº“ (Install dependencies)
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: 4. å®‰è£… UPX å‹ç¼©å·¥å…· (Install UPX)
      # åˆ©ç”¨ Windows äº‘æœåŠ¡å™¨è‡ªå¸¦çš„ choco åŒ…ç®¡ç†å™¨ä¸€é”®å®‰è£… UPX
      run: choco install upx

    - name: 5. æ‰§è¡Œ Spec æ‰“åŒ… (Build executable)
      run: pyinstaller c_cleaner_plus.spec --clean
      env:
        # å¼ºåˆ¶ Python ç»ˆç«¯ä½¿ç”¨ UTF-8 ç¼–ç ï¼Œé˜²æ­¢ä¸­æ–‡è¾“å‡ºæŠ¥é”™
        PYTHONIOENCODING: utf8  

    - name: 6. æå– main.py çš„ä¸“å±å®Œæ•´æ›´æ–°æ—¥å¿— (Extract main.py commits)
      # å¼ºåˆ¶åœ¨ Windows ä¸Šä½¿ç”¨ bash è¿è¡Œï¼Œå…¼å®¹ Linux é£æ ¼çš„æ–‡æœ¬å¤„ç†å‘½ä»¤
      shell: bash 
      run: |
        echo "### \`main.py\` æ›´æ–°æ—¥å¿—" > main_release_notes.txt
        echo "" >> main_release_notes.txt
        
        # å°è¯•å¯»æ‰¾ä¸Šä¸€ä¸ªç‰ˆæœ¬ Tag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$PREV_TAG" ]; then
          # å¦‚æœæ‰¾ä¸åˆ°ä¸Šä¸€ä¸ª Tag (é¦–æ¬¡å‘å¸ƒ)ï¼Œæ‹‰å– main.py æ‰€æœ‰çš„å†å²å®Œæ•´ç•™è¨€ (%B)
          git log --format="**ğŸ’¡ æäº¤æ›´æ–°:**%n%B%n---" -- main.py >> main_release_notes.txt
        else
          # å¦‚æœæ‰¾åˆ°äº†ä¸Šä¸€ä¸ª Tagï¼Œåªæ‹‰å–è¿™ä¸¤ä¸ªç‰ˆæœ¬ä¹‹é—´ main.py çš„å®Œæ•´ç•™è¨€ (%B)
          git log --format="**ğŸ’¡ æäº¤æ›´æ–°:**%n%B%n---" $PREV_TAG..HEAD -- main.py >> main_release_notes.txt
        fi
        
        # å¦‚æœæ£€æµ‹åˆ° main.py æ²¡æœ‰å‘ç”Ÿè¿‡æäº¤ (æ–‡ä»¶åªæœ‰æ ‡é¢˜é‚£ä¸¤è¡Œ)
        if [ $(wc -l < main_release_notes.txt) -le 2 ]; then
          echo "- æœ¬æ¬¡ç‰ˆæœ¬æ›´æ–°ä¸­ï¼Œ\`main.py\` æ²¡æœ‰ä»£ç å˜åŠ¨æˆ–è¯¦ç»†æäº¤è®°å½•ã€‚" >> main_release_notes.txt
        fi

    - name: 7. è‡ªåŠ¨åˆ›å»º GitHub Release å¹¶ä¸Šä¼  (Create Release)
      uses: softprops/action-gh-release@v2
      with:
        # æ•è· dist ç›®å½•ä¸‹çš„æ‰€æœ‰ exe æ–‡ä»¶
        files: dist/*.exe
        # æ™ºèƒ½å‘½åï¼šå¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘å°±ç”¨è¾“å…¥æ¡†çš„ç‰ˆæœ¬å·ï¼Œå¦‚æœæ˜¯ push tag è§¦å‘å°±ç”¨ tag åç§°
        tag_name: ${{ github.event.inputs.version_tag || github.ref_name }}
        # ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¯»å–ç¬¬ 6 æ­¥åŠ¨æ€ç”Ÿæˆçš„çº¯æ–‡æœ¬æ—¥å¿—æ–‡ä»¶
        body_path: main_release_notes.txt  
        # è‡ªåŠ¨æ£€æµ‹ç‰ˆæœ¬å·ä¸­æ˜¯å¦åŒ…å« "alpha" æˆ– "beta"ï¼Œå¦‚æœåŒ…å«åˆ™è‡ªåŠ¨æ‰“ä¸Š Pre-release æ ‡è®°
        prerelease: ${{ contains(github.event.inputs.version_tag || github.ref_name, 'alpha') || contains(github.event.inputs.version_tag || github.ref_name, 'beta') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
